<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FarmPulse ‚Äî AI Farm Co-Pilot</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --soil: #1a1208;
      --earth: #2d1f0a;
      --bark: #3d2b10;
      --clay: #7a4f2a;
      --wheat: #d4a84b;
      --sun: #f5c842;
      --lime: #7ecb35;
      --leaf: #4a9b2f;
      --forest: #2d6b1a;
      --sky: #5bb8e0;
      --mist: #e8f4e8;
      --cream: #faf6ed;
      --text: #1a1208;
      --textmid: #5a4a2a;
      --card: rgba(255, 255, 255, 0.85);
      --glow: rgba(126, 203, 53, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--soil);
      color: var(--cream);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* === BACKGROUND === */
    .bg-layer {
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 80% 60% at 10% 20%, rgba(45, 107, 26, 0.25) 0%, transparent 60%),
        radial-gradient(ellipse 60% 80% at 90% 80%, rgba(122, 79, 42, 0.3) 0%, transparent 60%),
        radial-gradient(ellipse 100% 100% at 50% 50%, #1a1208 0%, #0d0a04 100%);
    }

    .bg-grid {
      position: fixed;
      inset: 0;
      z-index: 0;
      background-image: linear-gradient(rgba(126, 203, 53, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(126, 203, 53, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    /* === NAV === */
    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 40px;
      background: rgba(26, 18, 8, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(126, 203, 53, 0.15);
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--lime);
      letter-spacing: -0.5px;
    }

    .logo span {
      color: var(--wheat);
    }

    .nav-tabs {
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 4px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .nav-tab {
      padding: 8px 18px;
      border-radius: 9px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.5);
      transition: all 0.25s ease;
      white-space: nowrap;
      font-family: 'DM Sans', sans-serif;
    }

    .nav-tab.active {
      background: var(--lime);
      color: var(--soil);
      font-weight: 700;
    }

    .nav-tab:hover:not(.active) {
      color: var(--lime);
    }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(126, 203, 53, 0.1);
      border: 1px solid rgba(126, 203, 53, 0.25);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: 0.78rem;
      color: var(--lime);
    }

    .pulse-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--lime);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(126, 203, 53, 0.4);
      }

      50% {
        opacity: 0.7;
        transform: scale(1.1);
        box-shadow: 0 0 0 5px rgba(126, 203, 53, 0);
      }
    }

    /* === MAIN === */
    main {
      position: relative;
      z-index: 1;
      padding: 100px 40px 60px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* === HERO === */
    .hero {
      text-align: center;
      padding: 60px 0 50px;
      animation: fadeUp 0.8s ease both;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(126, 203, 53, 0.1);
      border: 1px solid rgba(126, 203, 53, 0.3);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 0.78rem;
      color: var(--lime);
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 24px;
    }

    .hero h1 {
      font-family: 'Syne', sans-serif;
      font-size: clamp(2.8rem, 6vw, 5rem);
      font-weight: 800;
      line-height: 1.05;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #ffffff 0%, var(--lime) 50%, var(--wheat) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero p {
      font-size: 1.15rem;
      color: rgba(255, 255, 255, 0.55);
      max-width: 560px;
      margin: 0 auto 40px;
      line-height: 1.7;
    }

    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      flex-wrap: wrap;
      margin-bottom: 50px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-num {
      font-family: 'Syne', sans-serif;
      font-size: 2rem;
      font-weight: 800;
      color: var(--lime);
    }

    .stat-label {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 2px;
    }

    /* === SECTION === */
    .section {
      display: none;
      animation: fadeUp 0.5s ease both;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(24px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 30px;
    }

    .section-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--lime), var(--leaf));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      box-shadow: 0 8px 24px rgba(126, 203, 53, 0.3);
    }

    .section-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .section-sub {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 2px;
    }

    /* === CARDS === */
    .card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      padding: 28px;
      backdrop-filter: blur(10px);
      transition: border-color 0.3s, transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      border-color: rgba(126, 203, 53, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(126, 203, 53, 0.08);
    }

    .card-title {
      font-family: 'Syne', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: rgba(255, 255, 255, 0.9);
    }

    .card-sub {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.35);
      margin-bottom: 20px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* === UPLOAD AREA === */
    .upload-zone {
      border: 2px dashed rgba(126, 203, 53, 0.3);
      border-radius: 16px;
      padding: 50px 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(126, 203, 53, 0.03);
      position: relative;
      overflow: hidden;
    }

    .upload-zone:hover,
    .upload-zone.dragging {
      border-color: var(--lime);
      background: rgba(126, 203, 53, 0.07);
    }

    .upload-zone input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-text {
      font-size: 0.95rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .upload-text strong {
      color: var(--lime);
    }

    #preview-img {
      width: 100%;
      max-height: 240px;
      object-fit: cover;
      border-radius: 12px;
      display: none;
      margin-bottom: 16px;
    }

    #camera-preview {
      width: 100%;
      border-radius: 12px;
      display: none;
      margin-bottom: 16px;
      transform: scaleX(-1);
      /* Mirror effect */
    }

    .camera-controls {
      display: none;
      gap: 10px;
      margin-bottom: 12px;
      justify-content: center;
    }

    /* === BUTTONS === */
    .btn {
      padding: 12px 28px;
      border-radius: 12px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.25s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--lime), #5fa825);
      color: var(--soil);
      box-shadow: 0 4px 20px rgba(126, 203, 53, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(126, 203, 53, 0.5);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.07);
      color: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
    }

    /* === RESULT BOX === */
    .result-box {
      background: rgba(126, 203, 53, 0.06);
      border: 1px solid rgba(126, 203, 53, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
      display: none;
    }

    .result-box.show {
      display: block;
      animation: fadeUp 0.4s ease;
    }

    .result-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--lime);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .result-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .result-body {
      font-size: 0.88rem;
      color: rgba(255, 255, 255, 0.65);
      line-height: 1.7;
    }

    .severity-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .sev-high {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.25);
    }

    .sev-mid {
      background: rgba(245, 193, 66, 0.15);
      color: var(--wheat);
      border: 1px solid rgba(245, 193, 66, 0.25);
    }

    .sev-low {
      background: rgba(126, 203, 53, 0.15);
      color: var(--lime);
      border: 1px solid rgba(126, 203, 53, 0.25);
    }

    /* === LOADER === */
    .loader {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 30px;
      gap: 14px;
    }

    .loader.show {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(126, 203, 53, 0.15);
      border-top-color: var(--lime);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loader-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.4);
    }

    /* === CROP RECOMMENDATION === */
    .input-group {
      margin-bottom: 16px;
    }

    .input-label {
      display: block;
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.45);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 500;
    }

    .input-field {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.25s;
      outline: none;
    }

    .input-field:focus {
      border-color: rgba(126, 203, 53, 0.5);
    }

    .input-field option {
      background: #1a1208;
    }

    /* === CROP CARDS === */
    .crop-result-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-top: 20px;
    }

    .crop-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 18px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .crop-card:hover {
      border-color: var(--lime);
      transform: translateY(-3px);
    }

    .crop-card.best {
      border-color: rgba(126, 203, 53, 0.5);
      background: rgba(126, 203, 53, 0.07);
    }

    .crop-emoji {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .crop-name {
      font-family: 'Syne', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
    }

    .crop-score {
      font-size: 0.75rem;
      color: var(--lime);
      margin-top: 4px;
    }

    .crop-reason {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 6px;
      line-height: 1.4;
    }

    /* === MARKET PRICE === */
    .price-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .price-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .price-card:hover {
      border-color: rgba(126, 203, 53, 0.3);
    }

    .price-crop {
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .price-value {
      font-family: 'Syne', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      margin: 6px 0;
      color: white;
    }

    .price-change {
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .price-up {
      color: var(--lime);
    }

    .price-down {
      color: #f87171;
    }

    .sell-signal {
      margin-top: 10px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    .signal-buy {
      background: rgba(126, 203, 53, 0.15);
      color: var(--lime);
    }

    .signal-hold {
      background: rgba(245, 193, 66, 0.15);
      color: var(--wheat);
    }

    .signal-sell {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    /* mini chart */
    .mini-chart {
      height: 40px;
      margin-top: 10px;
      display: flex;
      align-items: flex-end;
      gap: 3px;
    }

    .bar {
      flex: 1;
      background: rgba(126, 203, 53, 0.2);
      border-radius: 3px 3px 0 0;
      transition: height 0.5s ease;
    }

    .bar.active {
      background: var(--lime);
    }

    /* === SOIL HEALTH === */
    .soil-meter {
      margin-bottom: 16px;
    }

    .meter-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .meter-name {
      font-size: 0.82rem;
      color: rgba(255, 255, 255, 0.6);
    }

    .meter-val {
      font-size: 0.82rem;
      font-weight: 600;
    }

    .meter-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 4px;
      overflow: hidden;
    }

    .meter-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--lime), var(--sun));
      transition: width 1.2s ease;
    }

    .fert-rec {
      background: rgba(212, 168, 75, 0.08);
      border: 1px solid rgba(212, 168, 75, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-top: 14px;
    }

    .fert-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--wheat);
      margin-bottom: 10px;
      font-weight: 600;
    }

    .fert-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.85rem;
    }

    .fert-item:last-child {
      border: none;
    }

    .fert-amount {
      color: var(--wheat);
      font-weight: 600;
    }

    /* === AI CHATBOT === */
    .chat-container {
      height: 340px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 4px;
      margin-bottom: 16px;
      scrollbar-width: thin;
      scrollbar-color: rgba(126, 203, 53, 0.2) transparent;
    }

    .chat-msg {
      display: flex;
      gap: 10px;
      animation: fadeUp 0.3s ease;
    }

    .chat-msg.user {
      flex-direction: row-reverse;
    }

    .msg-avatar {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.07);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .msg-avatar.ai {
      background: rgba(126, 203, 53, 0.15);
      border-color: rgba(126, 203, 53, 0.25);
    }

    .msg-bubble {
      max-width: 78%;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 0.87rem;
      line-height: 1.6;
    }

    .chat-msg.ai .msg-bubble {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.8);
      border-radius: 4px 14px 14px 14px;
    }

    .chat-msg.user .msg-bubble {
      background: rgba(126, 203, 53, 0.15);
      border: 1px solid rgba(126, 203, 53, 0.25);
      color: rgba(255, 255, 255, 0.9);
      border-radius: 14px 4px 14px 14px;
    }

    .chat-input-row {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.25s;
    }

    .chat-input:focus {
      border-color: rgba(126, 203, 53, 0.5);
    }

    .quick-questions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .quick-q {
      padding: 6px 13px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.78rem;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }

    .quick-q:hover {
      border-color: var(--lime);
      color: var(--lime);
    }

    /* === DASHBOARD === */
    .dash-kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 22px 20px;
      transition: all 0.3s;
    }

    .kpi-card:hover {
      border-color: rgba(126, 203, 53, 0.25);
    }

    .kpi-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.35);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-family: 'Syne', sans-serif;
      font-size: 1.9rem;
      font-weight: 800;
    }

    .kpi-value.green {
      color: var(--lime);
    }

    .kpi-value.yellow {
      color: var(--wheat);
    }

    .kpi-value.red {
      color: #f87171;
    }

    .kpi-change {
      font-size: 0.75rem;
      margin-top: 4px;
    }

    .kpi-change.up {
      color: var(--lime);
    }

    .kpi-change.down {
      color: #f87171;
    }

    /* weather strip */
    .weather-strip {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    .weather-day {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }

    .weather-day.today {
      border-color: rgba(91, 184, 224, 0.4);
      background: rgba(91, 184, 224, 0.07);
    }

    .w-day {
      font-size: 0.72rem;
      color: rgba(255, 255, 255, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .w-icon {
      font-size: 1.8rem;
      margin: 6px 0;
    }

    .w-temp {
      font-family: 'Syne', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .w-cond {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.35);
      margin-top: 2px;
    }

    /* alert cards */
    .alert-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid transparent;
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .alert-item.warn {
      border-color: var(--wheat);
      background: rgba(245, 193, 66, 0.05);
    }

    .alert-item.info {
      border-color: var(--sky);
      background: rgba(91, 184, 224, 0.05);
    }

    .alert-item.danger {
      border-color: #f87171;
      background: rgba(239, 68, 68, 0.05);
    }

    .alert-item.success {
      border-color: var(--lime);
      background: rgba(126, 203, 53, 0.05);
    }

    .alert-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }

    /* === MISC === */
    .divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.07);
      margin: 24px 0;
    }

    .tag {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 0.72rem;
      font-weight: 600;
      background: rgba(126, 203, 53, 0.12);
      color: var(--lime);
      border: 1px solid rgba(126, 203, 53, 0.2);
      margin-right: 6px;
      margin-bottom: 6px;
    }

    @media(max-width: 900px) {
      nav {
        padding: 14px 20px;
      }

      .nav-tabs {
        display: none;
      }

      main {
        padding: 90px 20px 40px;
      }

      .grid-2,
      .grid-3,
      .dash-kpi-grid,
      .crop-result-grid,
      .price-grid,
      .weather-strip {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media(max-width: 600px) {

      .grid-2,
      .grid-3,
      .dash-kpi-grid,
      .crop-result-grid,
      .price-grid,
      .weather-strip {
        grid-template-columns: 1fr;
      }
    }

    /* === SMART FARM === */
    .smart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .cctv-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #333;
    }

    .cctv-feed {
      width: 100%;
      display: block;
      transform: scaleX(-1);
      /* Mirror for natural feel */
    }

    .cctv-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #0f0;
      font-family: monospace;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.5);
      padding: 4px 8px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .rec-dot {
      width: 10px;
      height: 10px;
      background: red;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
      margin-left: auto;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.1);
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: var(--lime);
    }

    input:checked+.slider:before {
      transform: translateX(24px);
    }

    .motor-card {
      display: flex;
      align-items: center;
      padding: 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-item {
      font-size: 0.8rem;
      padding: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      color: rgba(255, 255, 255, 0.6);
    }

    .log-item.alert {
      color: #f87171;
    }

    .device-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.2s;
    }

    .device-item:hover {
      background: rgba(126, 203, 53, 0.15);
      border-color: var(--lime);
    }

    .sensor-box {
      background: rgba(0, 0, 0, 0.3);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .s-label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .s-val {
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      font-family: 'Syne', sans-serif;
    }

    /* CCTV PTZ Overlays */
    .ptz-controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      background: rgba(0, 0, 0, 0.5);
      padding: 6px;
      border-radius: 12px;
      z-index: 10;
    }

    .ptz-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.1s;
    }

    .ptz-btn:active {
      background: var(--lime);
      color: black;
      transform: scale(0.95);
    }

    .cam-status {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .status-icon {
      background: rgba(0, 0, 0, 0.6);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>

<body>
  <div class="bg-layer"></div>
  <div class="bg-grid"></div>

  <!-- NAV -->
  <nav>
    <div>
      <div class="logo">Farm<span>Pulse</span></div>
      <div style="font-size:0.75rem;opacity:0.7;margin-top:4px;color:rgba(255,255,255,0.6);">üìç 16.5¬∞N, 80.6¬∞E
        (Vijayawada, AP)</div>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('dashboard')">üè† Dashboard</button>
      <button class="nav-tab" onclick="showSection('disease')">üî¨ Disease AI</button>
      <button class="nav-tab" onclick="showSection('crops')">üå± Crop Advisor</button>
      <button class="nav-tab" onclick="showSection('market')">üìà Market</button>
      <button class="nav-tab" onclick="showSection('soil')">ü™± Soil Health</button>
      <button class="nav-tab" onclick="showSection('smart-farm')">üì° Smart Farm</button>
      <button class="nav-tab" onclick="showSection('doctor')">ü§ñ AI Suggests</button>
    </div>
    <div class="status-pill">
      <div class="pulse-dot"></div>
      AI Live
    </div>
  </nav>

  <main>

    <!-- ==================== DASHBOARD ==================== -->
    <section id="dashboard" class="section active">
      <div class="hero">
        <div class="hero-badge">üåæ AI-Powered Farm Intelligence</div>
        <h1>Your Farm's Brain,<br />In Your Pocket</h1>
        <p>Real-time AI advisory across crop health, soil, markets, and weather ‚Äî built for the modern farmer.</p>
        <div class="hero-stats">
          <div class="stat-item">
            <div class="stat-num">0</div>
            <div class="stat-label">Acres Monitored</div>
          </div>
          <div class="stat-item">
            <div class="stat-num">0</div>
            <div class="stat-label">AI Features</div>
          </div>
          <div class="stat-item">
            <div class="stat-num">0</div>
            <div class="stat-label">Active Crops</div>
          </div>
          <div class="stat-item">
            <div class="stat-num">24/7</div>
            <div class="stat-label">Live Monitoring</div>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="dash-kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Projected Revenue</div>
          <div class="kpi-value green">$0</div>
          <div class="kpi-change up">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Current Profit/Acre</div>
          <div class="kpi-value yellow">$0</div>
          <div class="kpi-change up">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Water Saved This Week</div>
          <div class="kpi-value green">0 L</div>
          <div class="kpi-change up">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Pest Risk Level</div>
          <div class="kpi-value yellow">-</div>
          <div class="kpi-change down">--</div>
        </div>
      </div>

      <!-- Weather -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-title">üå§Ô∏è 5-Day Weather Forecast</div>
        <div class="card-sub">Smart irrigation and harvest timing based on forecast</div>
        <div class="divider"></div>
        <div class="weather-strip">
          <div class="weather-day today">
            <div class="w-day">Today</div>
            <div class="w-icon">‚õÖ</div>
            <div class="w-temp">28¬∞C</div>
            <div class="w-cond">Partly Cloudy</div>
          </div>
          <div class="weather-day">
            <div class="w-day">Wed</div>
            <div class="w-icon">üåßÔ∏è</div>
            <div class="w-temp">23¬∞C</div>
            <div class="w-cond">Heavy Rain</div>
          </div>
          <div class="weather-day">
            <div class="w-day">Thu</div>
            <div class="w-icon">üå¶Ô∏è</div>
            <div class="w-temp">25¬∞C</div>
            <div class="w-cond">Light Rain</div>
          </div>
          <div class="weather-day">
            <div class="w-day">Fri</div>
            <div class="w-icon">‚òÄÔ∏è</div>
            <div class="w-temp">31¬∞C</div>
            <div class="w-cond">Sunny</div>
          </div>
          <div class="weather-day">
            <div class="w-day">Sat</div>
            <div class="w-icon">üå§Ô∏è</div>
            <div class="w-temp">29¬∞C</div>
            <div class="w-cond">Partly Cloudy</div>
          </div>
        </div>
      </div>

      <!-- Alerts + Quick Nav -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title">üîî Smart Alerts</div>
          <div class="card-sub">AI-generated action items for your farm</div>
          <div class="divider"></div>
          <div class="alert-list">
            <div class="alert-item danger">
              <span class="alert-icon">üö®</span>
              <div><strong>Early blight detected</strong> in Tomato field (Block C). Apply copper fungicide within 48
                hours.</div>
            </div>
            <div class="alert-item warn">
              <span class="alert-icon">‚ö†Ô∏è</span>
              <div><strong>Skip irrigation today</strong> ‚Äî heavy rain forecast tomorrow. Save ~‚Çπ2,400 in pump costs.
              </div>
            </div>
            <div class="alert-item success">
              <span class="alert-icon">üìà</span>
              <div><strong>Soybean price up 11%</strong> this week. Consider selling 30% of stock now.</div>
            </div>
            <div class="alert-item info">
              <span class="alert-icon">üíß</span>
              <div><strong>Soil moisture low</strong> in Field A (Corn). Schedule drip irrigation for Thursday.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üó∫Ô∏è Quick Access</div>
          <div class="card-sub">Jump to any AI feature</div>
          <div class="divider"></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;"
              onclick="showSection('disease')">üî¨ &nbsp; Diagnose Crop Disease from Photo</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;"
              onclick="showSection('crops')">üå± &nbsp; Get Best Crop Recommendation</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;"
              onclick="showSection('market')">üìà &nbsp; Check Live Market Prices</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;"
              onclick="showSection('soil')">ü™± &nbsp; Analyze Soil & Get Fertilizer Plan</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:flex-start;"
              onclick="showSection('doctor')">ü§ñ &nbsp; Chat with AI Crop Doctor</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== DISEASE DETECTION ==================== -->
    <section id="disease" class="section">
      <div class="section-header">
        <div class="section-icon">üî¨</div>
        <div>
          <div class="section-title">Pest & Disease Detection</div>
          <div class="section-sub">Upload a photo ‚Üí AI identifies disease + gives treatment plan in seconds</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">üì∏ Upload Crop Photo</div>
          <div class="card-sub">Take a close-up of affected leaves, stems, or fruits</div>
          <img id="preview-img" src="" alt="Preview" />
          <div class="upload-zone">
            <input type="file" accept="image/*" onchange="handleImageUpload(event)" />
            <img id="preview-img" src="" alt="Preview" />
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="camera-canvas" style="display:none;"></canvas>

            <div class="upload-icon">üì∏</div>
            <div class="upload-text">
              <strong>Click to Upload</strong> or Drag & Drop<br />
              <span style="font-size:0.8rem;opacity:0.6;">Supports: JPEG, PNG</span>
            </div>

            <div class="camera-controls" id="cam-controls">
              <button type="button" class="btn btn-secondary" onclick="stopCamera()">‚ùå Cancel</button>
              <button type="button" class="btn btn-primary" onclick="capturePhoto()">üîò Capture</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="btn btn-secondary" style="flex:1;" onclick="startCamera()">üì∑ Use Camera</button>
            <button class="btn btn-primary" style="flex:1;" id="analyze-btn" disabled onclick="analyzeDisease()">
              üî¨ Analyze Crop
            </button>
          </div>

          <div style="margin-top:16px;">
            <label class="input-label">Select Crop Type (optional)</label>
            <select class="input-field" id="crop-type-select">
              <option value="">Auto-detect</option>
              <option value="corn">üåΩ Corn / Maize</option>
              <option value="wheat">üåæ Wheat</option>
              <option value="soybean">ü´ò Soybean</option>
              <option value="rice">üåæ Rice</option>
              <option value="potato">ü•î Potato</option>
              <option value="cotton">üå∏ Cotton</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üß™ AI Diagnosis Result</div>
          <div class="card-sub">Detailed disease report with treatment plan</div>

          <div class="loader" id="disease-loader">
            <div class="spinner"></div>
            <div class="loader-text">AI analyzing your crop image‚Ä¶</div>
          </div>

          <div id="disease-result" class="result-box">
            <div class="result-label">Disease Detected</div>
            <div class="result-title" id="disease-name">‚Äî</div>
            <div id="disease-severity"></div>
            <div class="result-body" id="disease-body"></div>
          </div>

          <div id="disease-empty" style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.2);">
            <div style="font-size:3rem;margin-bottom:12px;">üî≠</div>
            <div>Upload a photo to get your AI diagnosis</div>
          </div>

          <!-- Example diseases for demo -->
          <div style="margin-top:20px;">
            <div class="card-sub" style="margin-bottom:12px;">üéØ Or try a demo example:</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              <button class="btn btn-secondary" style="font-size:0.78rem;padding:7px 13px;"
                onclick="loadDemo('blight')">üçÖ Tomato Blight</button>
              <button class="btn btn-secondary" style="font-size:0.78rem;padding:7px 13px;"
                onclick="loadDemo('rust')">üåæ
                Wheat Rust</button>
              <button class="btn btn-secondary" style="font-size:0.78rem;padding:7px 13px;"
                onclick="loadDemo('smut')">üåΩ
                Corn Smut</button>
              <button class="btn btn-secondary" style="font-size:0.78rem;padding:7px 13px;"
                onclick="loadDemo('aphid')">ü´ò
                Soybean Aphids</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== CROP RECOMMENDATION ==================== -->
    <section id="crops" class="section">
      <div class="section-header">
        <div class="section-icon">üå±</div>
        <div>
          <div class="section-title">Crop Recommendation System</div>
          <div class="section-sub">Enter your soil & location data ‚Üí AI recommends the most profitable crops</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">üìã Your Farm Details</div>
          <div class="card-sub">The more info you give, the better our AI recommends</div>
          <div class="divider"></div>

          <div class="grid-2">
            <div class="input-group">
              <label class="input-label">Soil Type</label>
              <select class="input-field" id="soil-type">
                <option>Sandy Loam</option>
                <option>Clay Loam</option>
                <option>Black Soil</option>
                <option>Red Soil</option>
                <option>Alluvial</option>
              </select>
            </div>
            <div class="input-group">
              <label class="input-label">Season</label>
              <select class="input-field" id="season">
                <option>Kharif (Monsoon)</option>
                <option>Rabi (Winter)</option>
                <option>Zaid (Summer)</option>
                <option>Year-Round</option>
              </select>
            </div>
            <div class="input-group">
              <label class="input-label">Rainfall (mm/yr)</label>
              <select class="input-field" id="rainfall">
                <option>
                  < 500mm (Low)</option>
                <option>500‚Äì1000mm (Medium)</option>
                <option>1000‚Äì1500mm (High)</option>
                <option>> 1500mm (Very High)</option>
              </select>
            </div>
            <div class="input-group">
              <label class="input-label">pH Level</label>
              <select class="input-field" id="ph-level">
                <option>6.0‚Äì6.5 (Slightly Acidic)</option>
                <option>6.5‚Äì7.0 (Neutral)</option>
                <option>7.0‚Äì7.5 (Slightly Alkaline)</option>
                <option>7.5‚Äì8.0 (Alkaline)</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label class="input-label">Available Water Source</label>
            <select class="input-field" id="water-source">
              <option>Rainfed only</option>
              <option>Borewell / Drip</option>
              <option>Canal / River</option>
              <option>Both Rainfed + Irrigation</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">Market Preference</label>
            <select class="input-field" id="market-pref">
              <option>Maximum Profit</option>
              <option>Minimum Risk</option>
              <option>Export Quality</option>
              <option>Local Consumption</option>
            </select>
          </div>

          <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="recommendCrops()">
            üåæ Get AI Crop Recommendations
          </button>
        </div>

        <div class="card">
          <div class="card-title">üèÜ AI Recommended Crops</div>
          <div class="card-sub">Ranked by suitability, profit potential & risk</div>
          <div class="divider"></div>

          <div class="loader" id="crop-loader">
            <div class="spinner"></div>
            <div class="loader-text">AI matching crops to your farm profile‚Ä¶</div>
          </div>

          <div id="crop-results" style="display:none;">
            <div class="crop-result-grid" id="crop-cards"></div>
            <div class="fert-rec" style="margin-top:16px;" id="crop-insight">
              <div class="fert-title">üí° AI Insight</div>
              <div id="crop-insight-text" style="font-size:0.84rem;color:rgba(255,255,255,0.6);line-height:1.6;"></div>
            </div>
          </div>

          <div id="crop-empty" style="text-align:center;padding:60px 20px;color:rgba(255,255,255,0.2);">
            <div style="font-size:3rem;margin-bottom:12px;">üåæ</div>
            <div>Fill in your farm details to get personalized crop recommendations</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== MARKET PRICE ==================== -->
    <section id="market" class="section">
      <div class="section-header">
        <div class="section-icon">üìà</div>
        <div>
          <div class="section-title">Market Price Advisor</div>
          <div class="section-sub">Live commodity prices + AI buy/sell signals + price trend forecasts</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
          <div>
            <div class="card-title">üåç Live Commodity Prices</div>
            <div class="card-sub">Updated every 15 minutes ¬∑ AI sell signals included</div>
          </div>
          <div style="display:flex;gap:10px;">
            <select class="input-field" id="region-select" style="width:auto;" onchange="updatePrices()">
              <option>India (INR/Quintal)</option>
              <option>US (USD/Bushel)</option>
              <option>Global (USD/MT)</option>
            </select>
            <button class="btn btn-primary" onclick="refreshPrices()">üîÑ Refresh</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="price-grid" id="price-grid"></div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">ü§ñ AI Price Prediction</div>
          <div class="card-sub">7-day forecast based on weather, demand & historical data</div>
          <div class="divider"></div>
          <div id="price-prediction">
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div class="alert-item success">
                <span class="alert-icon">üìà</span>
                <div><strong>Wheat:</strong> Expected to rise 8‚Äì12% in next 7 days due to export demand spike from North
                  Africa.</div>
              </div>
              <div class="alert-item warn">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div><strong>Corn:</strong> Price may dip 5% after upcoming harvest season glut. Sell before Friday if
                  possible.</div>
              </div>
              <div class="alert-item info">
                <span class="alert-icon">üí°</span>
                <div><strong>Soybean:</strong> Stable prices for next 14 days. Good time to negotiate forward contracts.
                </div>
              </div>
              <div class="alert-item success">
                <span class="alert-icon">üöÄ</span>
                <div><strong>Tomato:</strong> Festival season demand spike predicted. Prices may surge 20‚Äì25% next week.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">üìä Profit Calculator</div>
          <div class="card-sub">Calculate your exact earnings before selling</div>
          <div class="divider"></div>
          <div class="input-group">
            <label class="input-label">Select Crop</label>
            <select class="input-field" id="calc-crop" onchange="calcProfit()">
              <option value="wheat">Wheat</option>
              <option value="corn">Corn</option>
              <option value="soybean">Soybean</option>
              <option value="tomato">Tomato</option>
            </select>
          </div>
          <div class="input-group">
            <label class="input-label">Quantity (Quintals)</label>
            <input type="number" class="input-field" id="calc-qty" value="0" oninput="calcProfit()" />
          </div>
          <div class="input-group">
            <label class="input-label">Cost of Production (per Quintal)</label>
            <input type="number" class="input-field" id="calc-cost" value="0" oninput="calcProfit()" />
          </div>
          <div class="fert-rec" id="profit-result">
            <div class="fert-title">üí∞ Profit Estimate</div>
            <div class="fert-item"><span>Market Price</span><span class="fert-amount" id="mkt-price">‚Çπ2,150/q</span>
            </div>
            <div class="fert-item"><span>Total Revenue</span><span class="fert-amount" id="total-rev">‚Çπ1,07,500</span>
            </div>
            <div class="fert-item"><span>Total Cost</span><span style="color:#f87171;font-weight:600;"
                id="total-cost">‚Çπ60,000</span></div>
            <div class="fert-item"><span><strong>Net Profit</strong></span><span
                style="color:var(--lime);font-weight:700;font-size:1.1rem;" id="net-profit">‚Çπ47,500</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== SOIL HEALTH ==================== -->
    <section id="soil" class="section">
      <div class="section-header">
        <div class="section-icon">ü™±</div>
        <div>
          <div class="section-title">Soil Health + Fertilizer Plan</div>
          <div class="section-sub">Enter soil test values ‚Üí AI generates a precision fertilizer recommendation</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <div class="card-title">üß™ Soil Test Input</div>
          <div class="card-sub">Enter values from your soil test report</div>
          <div class="divider"></div>

          <div class="grid-2">
            <div class="input-group">
              <label class="input-label">Nitrogen (N) kg/ha</label>
              <input type="number" class="input-field" id="soil-n" value="0" oninput="updateSoilMeters()" />
            </div>
            <div class="input-group">
              <label class="input-label">Phosphorus (P) kg/ha</label>
              <input type="number" class="input-field" id="soil-p" value="0" oninput="updateSoilMeters()" />
            </div>
            <div class="input-group">
              <label class="input-label">Potassium (K) kg/ha</label>
              <input type="number" class="input-field" id="soil-k" value="0" oninput="updateSoilMeters()" />
            </div>
            <div class="input-group">
              <label class="input-label">Organic Carbon %</label>
              <input type="number" class="input-field" id="soil-oc" value="0" step="0.1" oninput="updateSoilMeters()" />
            </div>
            <div class="input-group">
              <label class="input-label">pH Level</label>
              <input type="number" class="input-field" id="soil-ph" value="0" step="0.1" oninput="updateSoilMeters()" />
            </div>
            <div class="input-group">
              <label class="input-label">Crop to Grow</label>
              <select class="input-field" id="soil-crop" onchange="updateFertPlan()">
                <option>Wheat</option>
                <option>Corn</option>
                <option>Soybean</option>
                <option>Tomato</option>
                <option>Rice</option>
                <option>Cotton</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:8px;"
            onclick="updateFertPlan()">
            üß¨ Generate Fertilizer Plan
          </button>
        </div>

        <div class="card">
          <div class="card-title">üìä Soil Health Dashboard</div>
          <div class="card-sub">Current nutrient levels vs optimal range</div>
          <div class="divider"></div>

          <div id="soil-meters">
            <div class="soil-meter">
              <div class="meter-label"><span class="meter-name">Nitrogen (N)</span><span class="meter-val" id="n-val"
                  style="color:#f87171;">Low</span></div>
              <div class="meter-bar">
                <div class="meter-fill" id="n-fill"
                  style="width:45%;background:linear-gradient(90deg,#f87171,#fb923c);"></div>
              </div>
            </div>
            <div class="soil-meter">
              <div class="meter-label"><span class="meter-name">Phosphorus (P)</span><span class="meter-val" id="p-val"
                  style="color:var(--wheat);">Medium</span></div>
              <div class="meter-bar">
                <div class="meter-fill" id="p-fill" style="width:60%;"></div>
              </div>
            </div>
            <div class="soil-meter">
              <div class="meter-label"><span class="meter-name">Potassium (K)</span><span class="meter-val" id="k-val"
                  style="color:var(--lime);">High</span></div>
              <div class="meter-bar">
                <div class="meter-fill" id="k-fill" style="width:85%;"></div>
              </div>
            </div>
            <div class="soil-meter">
              <div class="meter-label"><span class="meter-name">Organic Carbon</span><span class="meter-val" id="oc-val"
                  style="color:#f87171;">Low</span></div>
              <div class="meter-bar">
                <div class="meter-fill" id="oc-fill"
                  style="width:30%;background:linear-gradient(90deg,#f87171,#fb923c);"></div>
              </div>
            </div>
            <div class="soil-meter">
              <div class="meter-label"><span class="meter-name">pH Balance</span><span class="meter-val" id="ph-val"
                  style="color:var(--lime);">Optimal</span></div>
              <div class="meter-bar">
                <div class="meter-fill" id="ph-fill" style="width:78%;"></div>
              </div>
            </div>
          </div>

          <div class="fert-rec" id="fert-plan">
            <div class="fert-title">üåø AI Fertilizer Recommendation ‚Äî Wheat</div>
            <div class="fert-item"><span>Urea (N Source)</span><span class="fert-amount">110 kg/acre</span></div>
            <div class="fert-item"><span>DAP (P Source)</span><span class="fert-amount">35 kg/acre</span></div>
            <div class="fert-item"><span>MOP (K Source)</span><span class="fert-amount">0 kg/acre ‚úì</span></div>
            <div class="fert-item"><span>FYM / Compost</span><span class="fert-amount">2 tons/acre</span></div>
            <div class="fert-item"><span>Zinc Sulphate</span><span class="fert-amount">10 kg/acre</span></div>
            <div style="font-size:0.78rem;color:rgba(255,255,255,0.35);margin-top:10px;line-height:1.5;">
              ‚è± Apply Urea in 2 splits: 50% at sowing, 50% at tillering stage. DAP at sowing only.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== SMART FARM (IoT) ==================== -->
    <section id="smart-farm" class="section">
      <div class="section-header">
        <div class="section-icon">üì°</div>
        <div>
          <div class="section-title">Smart Farm Control Center</div>
          <div class="section-sub">Remote Motor Control ‚Ä¢ CCTV ‚Ä¢ Live Sensors</div>
        </div>
      </div>

      <div class="smart-grid">
        <!-- Sensor Hub -->
        <div class="card">
          <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span>üì° Live Sensors</span>
            <button class="btn btn-secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="openDeviceManager()">‚ûï
              Add Device</button>
          </div>
          <div class="card-sub">Real-time crop telemetry</div>
          <div class="divider"></div>

          <div id="sensor-placeholder"
            style="text-align:center;padding:20px;color:rgba(255,255,255,0.3);font-size:0.85rem;">
            No physical devices connected.<br />Click "Add Device" to pair sensors.
          </div>

          <div id="live-sensors" style="display:none;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="sensor-box">
              <div class="s-label">Soil Moisture</div>
              <div class="s-val" id="live-moisture">--%</div>
            </div>
            <div class="sensor-box">
              <div class="s-label">Canopy Temp</div>
              <div class="s-val" id="live-temp">--¬∞C</div>
            </div>
            <div class="sensor-box" style="grid-column:span 2;">
              <div class="s-label">NPK Levels (mg/kg)</div>
              <div class="s-val" style="font-size:1rem;" id="live-npk">N:-- P:-- K:--</div>
            </div>
            <div style="grid-column:span 2;font-size:0.7rem;color:var(--lime);margin-top:5px;">
              ‚ö° Data streaming to AI Doctor & Soil Plan
            </div>
          </div>
        </div>

        <!-- Motor Controls -->
        <div class="card">
          <div class="card-title">üíß Irrigation Motors</div>
          <div class="card-sub">Remote control for water pumps</div>
          <div class="divider"></div>

          <div class="motor-card">
            <div>
              <div style="font-weight:700;">Main Borewell Pump</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">North Field ‚Ä¢ 5HP</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="motor1" onchange="toggleMotor('Main Borewell', this)">
              <span class="slider"></span>
            </label>
          </div>

          <div class="motor-card">
            <div>
              <div style="font-weight:700;">Drip Irrigation Pump</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Greenhouse ‚Ä¢ 2HP</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="motor2" onchange="toggleMotor('Drip System', this)">
              <span class="slider"></span>
            </label>
          </div>

          <div class="alert-item info" id="motor-status" style="margin-top:20px;display:none;">
            <div class="alert-icon">‚ÑπÔ∏è</div>
            <div>Status updated successfully via IoT Gateway.</div>
          </div>
        </div>

        <!-- CCTV Panel -->
        <div class="card">
          <div class="card-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span>üìπ Security CCTV</span>
            <span style="font-size:0.65rem;background:#0057b7;padding:2px 6px;border-radius:4px;">Powered by VIGI</span>
          </div>
          <div class="card-sub">Live feed with AI motion detection</div>
          <div class="divider"></div>

          <div class="cctv-container" id="cctv-container">
            <video id="cctv-feed" class="cctv-feed" autoplay playsinline muted></video>

            <div class="cctv-overlay">
              <div class="rec-dot"></div> REC ‚Ä¢ LIVE
            </div>

            <div class="cam-status">
              <div class="status-icon">üîã 85%</div>
              <div class="status-icon">üì∂ 4G</div>
            </div>

            <div class="ptz-controls">
              <div></div>
              <button class="ptz-btn" onclick="ptz('up')">‚ñ≤</button>
              <div></div>
              <button class="ptz-btn" onclick="ptz('left')">‚óÄ</button>
              <button class="ptz-btn" onclick="toggleFullscreen()" style="font-size:1.2rem;">‚õ∂</button>
              <button class="ptz-btn" onclick="ptz('right')">‚ñ∂</button>
              <div></div>
              <button class="ptz-btn" onclick="ptz('down')">‚ñº</button>
              <div></div>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;">
            <button class="btn btn-primary" style="flex:1;" onclick="startCCTV()">‚ñ∂ Start Feed</button>
            <button class="btn btn-secondary" style="flex:1;" onclick="stopCCTV()">‚èπ Stop</button>
            <button class="btn btn-secondary" style="width:100%;justify-content:center;margin-top:8px;"
              onclick="document.getElementById('device-manager').style.display='flex'">
              üì° Connect External Device
            </button>
          </div>

          <div style="margin-top:20px;">
            <div class="card-title" style="font-size:1rem;">üõ°Ô∏è Security Log</div>
            <div id="security-log"
              style="height:150px;overflow-y:auto;background:rgba(0,0,0,0.2);border-radius:8px;margin-top:10px;">
              <div class="log-item">System Armed - Waiting for feed...</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== AI SUGGESTS ==================== -->
    <section id="doctor" class="section">
      <div class="section-header">
        <div class="section-icon">ü§ñ</div>
        <div>
          <div class="section-title">AI Suggests</div>
          <div class="section-sub">Chat with your personal AI farm advisor ‚Äî ask anything about crops, pests, soil,
            markets</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card" style="display:flex;flex-direction:column;">
          <div class="card-title">üí¨ Chat with AI Suggests</div>
          <div class="card-sub">Powered by advanced agricultural AI ‚Äî available 24/7</div>
          <div class="divider"></div>

          <div class="quick-questions">
            <button class="quick-q" onclick="sendQuick('My corn leaves are turning yellow. What should I do?')">üåΩ
              Yellow corn leaves?</button>
            <button class="quick-q" onclick="sendQuick('When is the best time to sell my wheat?')">‚è∞ Best time to sell
              wheat?</button>
            <button class="quick-q" onclick="sendQuick('How much water does soybean need per week?')">üíß Soybean water
              needs?</button>
            <button class="quick-q" onclick="sendQuick('How do I control aphids organically?')">üêõ Control
              aphids?</button>
            <button class="quick-q" onclick="startCamera()">üì∑ Use Camera</button>
            <button class="quick-q" onclick="sendQuick('What fertilizer should I use before monsoon?')">üåßÔ∏è Pre-monsoon
              fertilizer?</button>
            <button class="quick-q" onclick="sendQuick('Is my soil pH of 6.8 good for rice?')">üåæ Soil pH for
              rice?</button>
          </div>

          <div class="chat-container" id="chat-container">
            <div class="chat-msg ai">
              <div class="msg-avatar ai">ü§ñ</div>
              <div class="msg-bubble">
                <strong>Namaste! I'm "AI Suggests" ‚Äî your farm advisor üåæ</strong><br /><br />
                I can help you with crop diseases, pest control, fertilizer advice, irrigation planning, market timing,
                and any farming question you have. I understand your farm has 100 acres with multiple crops.<br /><br />
                What's on your mind today? You can also upload a photo of your crop in the Disease AI tab for a visual
                diagnosis.
              </div>
            </div>
          </div>
          <input type="text" class="chat-input" id="chat-input"
            placeholder="Ask anything ‚Äî e.g. 'My tomato leaves have brown spots'"
            onkeydown="if(event.key==='Enter') sendChat()" />
          <select id="voice-lang" class="chat-input"
            style="width:auto;padding:0 8px;margin-right:4px;font-size:0.8rem;">
            <option value="en-IN">üá¨üáß English</option>
            <option value="hi-IN">üáÆüá≥ Hindi</option>
            <option value="ta-IN">üáÆüá≥ Tamil</option>
            <option value="te-IN">üáÆüá≥ Telugu</option>
          </select>
          <button class="btn btn-secondary" id="mic-btn" onclick="startVoiceInput()"
            style="padding:0 12px;font-size:1.2rem;">üé§</button>
          <button class="btn btn-primary" onclick="sendChat()">Send ‚Üí</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìö Knowledge Base</div>
        <div class="card-sub">Common issues for your crops ‚Äî click to get instant answers</div>
        <div class="divider"></div>

        <div style="display:flex;flex-direction:column;gap:10px;">
          <div
            style="font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.3);margin-bottom:4px;">
            üåΩ Corn / Maize</div>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('How to treat Northern Corn Leaf Blight?')">Northern Corn Leaf Blight
            treatment</button>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('My corn is not pollinating properly')">Poor corn pollination fix</button>

          <div
            style="font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.3);margin:8px 0 4px;">
            üåæ Wheat</div>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('How to treat yellow rust in wheat?')">Yellow rust treatment</button>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('Wheat lodging prevention tips')">Wheat lodging prevention</button>

          <div
            style="font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.3);margin:8px 0 4px;">
            ü´ò Soybean</div>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('Soybean root rot symptoms and treatment')">Root rot symptoms & cure</button>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('How to improve soybean yield per acre?')">Improve soybean yield</button>

          <div
            style="font-size:0.78rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.3);margin:8px 0 4px;">
            üçÖ Tomato</div>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('Tomato early blight vs late blight differences and treatment')">Early vs Late
            Blight</button>
          <button class="btn btn-secondary" style="text-align:left;font-size:0.82rem;"
            onclick="sendQuick('Tomato blossom drop causes and solution')">Blossom drop causes</button>
        </div>
      </div>
      </div>
    </section>

  </main>

  <!-- ==================== DEVICE MANAGER (IoT) ==================== -->
  <div id="device-manager"
    style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;">
    <div class="card" style="width:90%;max-width:500px;background:#1a1208;border:1px solid rgba(255,255,255,0.1);">
      <div class="card-title">üì° Connect Physical Sensors</div>
      <div class="card-sub">Scanning for nearby FarmPulse IoT devices...</div>
      <div class="divider"></div>

      <div id="scan-anim" style="text-align:center;padding:30px;">
        <div class="spinner" style="margin:0 auto 20px;"></div>
        <div style="color:rgba(255,255,255,0.5);">Searching via Bluetooth & Wi-Fi...</div>
      </div>

      <div id="device-list" style="display:none;flex-direction:column;gap:10px;">
        <div class="device-item" onclick="connectDevice('Soil-Pro-X1')">
          <div style="font-weight:700;">üå± Soil-Pro X1</div>
          <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Signal: Strong ‚Ä¢ ID: #8821</div>
        </div>
        <div class="device-item" onclick="connectDevice('Agri-Sense Weather')">
          <div style="font-weight:700;">üå°Ô∏è Agri-Sense Weather</div>
          <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Signal: Medium ‚Ä¢ ID: #B290</div>
        </div>
        <!-- New Options -->
        <div class="device-item" onclick="connectDevice('Phone Camera (IP Webcam)')">
          <div style="font-weight:700;">üì± Phone Camera (IP Webcam)</div>
          <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Status: Discoverable ‚Ä¢ Wi-Fi</div>
        </div>
        <div class="device-item" onclick="connectDevice('Generic RTSP/ONVIF Camera')">
          <div style="font-weight:700;">üìπ Generic IP Camera (RTSP)</div>
          <div style="font-size:0.75rem;color:rgba(255,255,255,0.5);">Protocol: ONVIF ‚Ä¢ Port: 554</div>
        </div>
      </div>

      <!-- Manual Input for Realism -->
      <div id="manual-ip-input" style="display:none;margin-top:15px;width:100%;">
        <label style="display:block;font-size:0.75rem;margin-bottom:5px;color:rgba(255,255,255,0.6);">Enter Camera
          Stream URL:</label>
        <input type="text" id="camera-url" placeholder="http://192.168.1.5:8080/video"
          style="width:100%;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:8px;border-radius:4px;font-size:0.85rem;">
        <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:8px;"
          onclick="connectManualDevice()">
          üîó Connect Stream
        </button>
      </div>

      <button class="btn btn-secondary" style="width:100%;margin-top:20px;justify-content:center;"
        onclick="closeDeviceManager()">Cancel</button>
    </div>
  </div>

  <script>
    // ===== NAVIGATION =====
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      const tabs = ['dashboard', 'disease', 'crops', 'market', 'soil', 'smart-farm', 'doctor'];
      const idx = tabs.indexOf(id);
      document.querySelectorAll('.nav-tab')[idx].classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== DISEASE DETECTION =====
    let videoStream = null;

    async function startCamera() {
      try {
        showSection('disease');
        const video = document.getElementById('camera-preview');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        videoStream = stream;
        video.srcObject = stream;
        video.style.display = 'block';

        // Hide upload UI
        document.querySelector('.upload-icon').style.display = 'none';
        document.querySelector('.upload-text').style.display = 'none';
        document.getElementById('preview-img').style.display = 'none';
        document.getElementById('cam-controls').style.display = 'flex';

      } catch (err) {
        alert("Could not access camera: " + err);
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      document.getElementById('camera-preview').style.display = 'none';
      document.getElementById('cam-controls').style.display = 'none';
      document.querySelector('.upload-icon').style.display = 'block';
      document.querySelector('.upload-text').style.display = 'block';
    }

    function capturePhoto() {
      const video = document.getElementById('camera-preview');
      const canvas = document.getElementById('camera-canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const dataURL = canvas.toDataURL('image/jpeg');
      document.getElementById('preview-img').src = dataURL;
      document.getElementById('preview-img').style.display = 'block';

      stopCamera();
      document.querySelector('.upload-icon').style.display = 'none';
      document.querySelector('.upload-text').style.display = 'none';
      document.getElementById('analyze-btn').disabled = false;
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.getElementById('preview-img');
        img.src = e.target.result;
        img.style.display = 'block';
        document.querySelector('.upload-icon').style.display = 'none';
        document.querySelector('.upload-text').style.display = 'none';
        document.getElementById('analyze-btn').disabled = false;
      };
      reader.readAsDataURL(file);
    }

    async function analyzeDisease() {
      const btn = document.getElementById('analyze-btn');
      const img = document.getElementById('preview-img');
      const cropType = document.getElementById('crop-type-select')?.value || 'corn';
      const lang = document.getElementById('voice-lang')?.value || 'en-IN';

      if (!img.src) { alert("Please upload or capture an image first."); return; }

      // Reset UI
      document.getElementById('disease-empty').style.display = 'none';
      document.getElementById('disease-loader').classList.add('show');
      document.getElementById('disease-result').style.display = 'none';
      btn.disabled = true; btn.textContent = "Analyzing...";

      try {
        // Convert Base64 to Blob
        const fetchResponse = await fetch(img.src);
        const blob = await fetchResponse.blob();

        const formData = new FormData();
        formData.append('file', blob, 'capture.jpg');
        formData.append('crop_type', cropType);
        formData.append('language', lang); // Send selected language

        const response = await fetch('http://localhost:8000/verify-crop', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error("Analysis failed");

        const data = await response.json();

        // Update UI with Result
        document.getElementById('disease-loader').classList.remove('show');
        document.getElementById('disease-result').style.display = 'block';

        // Display Disease Info from Backend
        const info = data.disease_diagnosis || { name: "Healthy / Unknown", severity: "low", body: "No specific disease detected." };

        document.getElementById('disease-name').textContent = info.name;

        // Severity Logic (Mock)
        const severity = info.name.includes("Healthy") ? "low" : "high";
        const sevHtml = severity === 'high' ?
          `<span class="severity-badge sev-high">üî¥ High Severity</span>` :
          `<span class="severity-badge sev-low">üü¢ Low Severity</span>`;
        document.getElementById('disease-severity').innerHTML = sevHtml;

        // Build Body HTML
        let bodyHtml = "";
        if (info.symptoms) bodyHtml += `<strong>Symptoms:</strong> ${info.symptoms}<br/><br/>`;
        if (info.cause) bodyHtml += `<strong>Cause:</strong> ${info.cause}<br/><br/>`;
        if (info.solution) bodyHtml += `<strong>Treatment:</strong> ${info.solution}<br/><br/>`;
        if (info.prevention) bodyHtml += `<strong>Prevention:</strong> ${info.prevention}`;

        document.getElementById('disease-body').innerHTML = bodyHtml;

        // Speak Result (Localized)
        let speechMsg = `Diagnosis complete. Detected potential ${info.name}.`;
        if (lang.startsWith('hi')) speechMsg = `‡§®‡§ø‡§¶‡§æ‡§® ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü‡•§ ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•ã‡§ó: ${info.name}`;
        if (lang.startsWith('te')) speechMsg = `‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞£ ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø: ${info.name}`;

        speakText(speechMsg);

      } catch (err) {
        console.error(err);
        alert("Error analyzing crop: " + err.message);
        document.getElementById('disease-loader').classList.remove('show');
      } finally {
        btn.disabled = false; btn.textContent = "üî¨ Analyze Crop";
      }
    }

    const diseaseDB = {
      blight: {
        name: 'Early Blight (Alternaria solani)',
        severity: 'high',
        body: `<strong>Symptoms:</strong> Dark brown circular spots with concentric rings (target board pattern) on older leaves. Yellow halo surrounds spots.<br/><br/>
    <strong>Cause:</strong> Fungal pathogen Alternaria solani. Spreads rapidly in warm, humid conditions (24‚Äì29¬∞C).<br/><br/>
    <strong>Treatment Plan:</strong><br/>
    1. Apply <strong>Mancozeb 75% WP</strong> @ 2g/L water immediately<br/>
    2. Follow up with <strong>Copper Oxychloride</strong> after 7 days<br/>
    3. Remove and burn affected leaves<br/>
    4. Avoid overhead irrigation<br/><br/>
    <strong>Estimated Yield Loss if Untreated:</strong> 30‚Äì50%<br/>
    <strong>Treatment Cost:</strong> ~‚Çπ1,200/acre`
      },
      rust: {
        name: 'Yellow Rust (Puccinia striiformis)',
        severity: 'high',
        body: `<strong>Symptoms:</strong> Yellow-orange pustules in stripes along leaf veins. Leaves eventually dry out and die.<br/><br/>
    <strong>Cause:</strong> Fungal pathogen Puccinia striiformis. Thrives in cool (10‚Äì15¬∞C) and moist conditions.<br/><br/>
    <strong>Treatment Plan:</strong><br/>
    1. Spray <strong>Propiconazole 25% EC</strong> @ 1ml/L water<br/>
    2. Apply <strong>Tebuconazole</strong> as a follow-up in 10 days<br/>
    3. Use resistant varieties in next planting season<br/><br/>
    <strong>Estimated Yield Loss if Untreated:</strong> 50‚Äì70%<br/>
    <strong>Treatment Cost:</strong> ~‚Çπ950/acre`
      },
      smut: {
        name: 'Common Smut (Ustilago maydis)',
        severity: 'mid',
        body: `<strong>Symptoms:</strong> Large, irregular galls (tumor-like growths) on ears, tassels, and leaves. Galls start white then turn black.<br/><br/>
    <strong>Cause:</strong> Soil-borne fungus. Infection occurs through wounds from insects or cultivation.<br/><br/>
    <strong>Treatment Plan:</strong><br/>
    1. Remove and destroy galls BEFORE they rupture<br/>
    2. Treat seeds with <strong>Thiram 75% WP</strong> @ 3g/kg seed<br/>
    3. Rotate with non-grass crops next season<br/>
    4. Improve drainage to reduce soil moisture<br/><br/>
    <strong>Estimated Yield Loss if Untreated:</strong> 10‚Äì30%<br/>
    <strong>Treatment Cost:</strong> ~‚Çπ600/acre`
      },
      aphid: {
        name: 'Soybean Aphid (Aphis glycines)',
        severity: 'mid',
        body: `<strong>Symptoms:</strong> Colonies of tiny yellow-green insects on undersides of leaves. Leaves curl, yellow, and wilt. Sticky honeydew attracts mold.<br/><br/>
    <strong>Cause:</strong> Rapid aphid population explosion in dry, warm weather. Also carries soybean mosaic virus.<br/><br/>
    <strong>Treatment Plan:</strong><br/>
    1. Spray <strong>Imidacloprid 17.8% SL</strong> @ 0.5ml/L water<br/>
    2. Alternatively use <strong>Neem Oil 5%</strong> for organic control<br/>
    3. Release lady beetles (natural predator) if possible<br/>
    4. Monitor weekly ‚Äî threshold is 250 aphids/plant<br/><br/>
    <strong>Estimated Yield Loss if Untreated:</strong> 20‚Äì40%<br/>
    <strong>Treatment Cost:</strong> ~‚Çπ500/acre`
      }
    };

    function loadDemo(type) {
      document.getElementById('disease-empty').style.display = 'none';
      document.getElementById('disease-loader').classList.add('show');
      document.getElementById('disease-result').classList.remove('show');

      setTimeout(() => {
        document.getElementById('disease-loader').classList.remove('show');
        const d = diseaseDB[type];
        document.getElementById('disease-name').textContent = d.name;
        const sevEl = document.getElementById('disease-severity');
        sevEl.innerHTML = `<span class="severity-badge ${d.severity === 'high' ? 'sev-high' : d.severity === 'mid' ? 'sev-mid' : 'sev-low'}">${d.severity === 'high' ? 'üî¥ High Severity' : d.severity === 'mid' ? 'üü° Medium Severity' : 'üü¢ Low Severity'}</span>`;
        document.getElementById('disease-body').innerHTML = d.body;
        document.getElementById('disease-result').classList.add('show');
      }, 1800);
    }

    async function analyzeDisease() {
      const fileInput = document.querySelector('input[type="file"]');
      const previewImg = document.getElementById('preview-img');
      const cropType = document.getElementById('crop-type-select').value;

      let formData = new FormData();

      if (fileInput.files.length > 0) {
        formData.append('image', fileInput.files[0]);
      } else if (previewImg.src.startsWith('data:')) {
        // Convert base64 to blob
        const res = await fetch(previewImg.src);
        const blob = await res.blob();
        formData.append('image', blob, 'camera-capture.jpg');
      } else {
        alert("Please upload an image or capture one using the camera.");
        return;
      }

      if (cropType) {
        formData.append('crop_type', cropType);
      }

      // UI Updates
      document.getElementById('disease-empty').style.display = 'none';
      document.getElementById('disease-loader').classList.add('show');
      document.getElementById('disease-result').classList.remove('show');

      try {
        // Call Backend API
        const response = await fetch('http://localhost:8000/verify-crop', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`Server Error: ${response.statusText}`);
        }

        const data = await response.json();

        // Hide loader
        document.getElementById('disease-loader').classList.remove('show');

        // Show Results (Mapping Backend Data to UI)
        if (data.disease_diagnosis) {
          // DETAILED DISEASE DIAGNOSIS
          const diag = data.disease_diagnosis;
          document.getElementById('disease-name').innerHTML = `ü§í ${diag.name} <button class="btn btn-sm btn-secondary" style="margin-left:10px;padding:2px 8px;" onclick="speakText('${diag.name}. ${diag.solution}')">üîä Listen</button>`;

          let details = `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:10px;">
                <strong>Symptoms:</strong> ${diag.symptoms}<br/><br/>
                <strong>Cause:</strong> ${diag.cause}
            </div>
            <div style="background:rgba(126, 203, 53, 0.1);padding:10px;border-radius:8px;border-left:3px solid var(--lime);">
                <strong>‚úÖ Solution:</strong> ${diag.solution}<br/>
                <strong>üõ°Ô∏è Prevention:</strong> ${diag.prevention}
            </div>
            <div style="margin-top:10px;font-size:0.8rem;opacity:0.7;">
                <strong>Defects Analysis:</strong> Bruises: ${data.defect_analysis?.bruise_count || 0} ‚Ä¢ Spots: ${data.defect_analysis?.spot_count || 0}
            </div>`;

          document.getElementById('disease-body').innerHTML = details;

          // Auto-speak result
          speakText(`Diagnosis complete. Detected ${diag.name}. Solution is: ${diag.solution}`);

        } else {
          // QUALITY GRADING ONLY
          document.getElementById('disease-name').textContent = data.quality_grade || "Analysis Complete";

          const sevEl = document.getElementById('disease-severity');
          const score = data.purity_score * 100;
          let severityClass = score > 90 ? 'sev-low' : score > 70 ? 'sev-mid' : 'sev-high';
          let severityText = score > 90 ? 'üü¢ High Quality' : score > 70 ? 'üü° Medium Quality' : 'üî¥ Low Quality';

          sevEl.innerHTML = `<span class="severity-badge ${severityClass}">${severityText} (${score.toFixed(1)}% Purity)</span>`;

          let details = `<strong>Defects Found:</strong><br/>`;
          if (data.defect_analysis) {
            details += `Bruises: ${data.defect_analysis.bruise_count}<br/>`;
            details += `Spots: ${data.defect_analysis.spot_count}<br/>`;
            details += `Color Uniformity: ${(data.defect_analysis.color_uniformity * 100).toFixed(1)}%<br/>`;
          }
          details += `<br/><strong>Estimated Value:</strong> ‚Çπ${data.estimated_valuation?.price_per_quintal || 0} / quintal`;

          document.getElementById('disease-body').innerHTML = details;
        }

        document.getElementById('disease-result').classList.add('show');

      } catch (err) {
        console.error(err);
        document.getElementById('disease-loader').classList.remove('show');
        alert("Failed to analyze image. Ensure the backend server is running.\nError: " + err.message);
      }
    }

    // ===== CROP RECOMMENDATION =====
    const cropDB = {
      "Sandy Loam": {
        "Kharif (Monsoon)": [
          { emoji: 'üåΩ', name: 'Corn', score: '97%', best: true, reason: 'Excellent drainage + warm temps = ideal for corn. High MSP support.' },
          { emoji: 'ü´ò', name: 'Soybean', score: '91%', reason: 'Good nitrogen fixation in sandy loam. Low input cost.' },
          { emoji: 'ü•ú', name: 'Groundnut', score: '85%', reason: 'Sandy loam perfect for pod development. Good local demand.' },
        ]
      },
      "Black Soil": {
        "Rabi (Winter)": [
          { emoji: 'üåæ', name: 'Wheat', score: '98%', best: true, reason: 'Black soil moisture retention is perfect for wheat. Highest profit potential.' },
          { emoji: 'üå∞', name: 'Chickpea', score: '88%', reason: 'Excellent in black soil. Fixes nitrogen. Low water requirement.' },
          { emoji: 'üå±', name: 'Linseed', score: '76%', reason: 'Good cash crop for black soil areas with MSP support.' },
        ]
      },
      "default": {
        "default": [
          { emoji: 'üåæ', name: 'Wheat', score: '94%', best: true, reason: 'Highly adaptable. Strong market price + government MSP support.' },
          { emoji: 'üåΩ', name: 'Corn', score: '88%', reason: 'High yield potential. Multiple uses (food, feed, ethanol).' },
          { emoji: 'ü´ò', name: 'Soybean', score: '82%', reason: 'Low input cost. Good export demand. Fixes soil nitrogen.' },
        ]
      }
    };

    function recommendCrops() {
      const soilType = document.getElementById('soil-type').value;
      const season = document.getElementById('season').value;

      document.getElementById('crop-empty').style.display = 'none';
      document.getElementById('crop-results').style.display = 'none';
      document.getElementById('crop-loader').classList.add('show');

      setTimeout(() => {
        document.getElementById('crop-loader').classList.remove('show');
        const key = cropDB[soilType]?.[season] ? soilType : 'default';
        const seasonKey = cropDB[key]?.[season] ? season : 'default';
        const crops = cropDB[key][seasonKey];

        const container = document.getElementById('crop-cards');
        container.innerHTML = crops.map(c => `
      <div class="crop-card ${c.best ? 'best' : ''}">
        ${c.best ? '<div style="font-size:0.65rem;color:var(--lime);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">‚≠ê Best Pick</div>' : ''}
        <div class="crop-emoji">${c.emoji}</div>
        <div class="crop-name">${c.name}</div>
        <div class="crop-score">Match: ${c.score}</div>
        <div class="crop-reason">${c.reason}</div>
      </div>
    `).join('');

        document.getElementById('crop-insight-text').innerHTML =
          `Based on your <strong>${soilType}</strong> soil in <strong>${season}</strong> season with your water source and market preference, our AI has ranked ${crops.length} suitable crops. <strong>${crops[0].name}</strong> is our top recommendation with ${crops[0].score} compatibility. Consider intercropping the top 2 picks for risk diversification and better income stability.`;

        document.getElementById('crop-results').style.display = 'block';
      }, 2000);
    }

    // ===== MARKET PRICES =====
    const priceData = [
      { crop: 'üåæ Wheat', price: '‚Çπ2,150', change: '+4.2%', up: true, signal: 'buy', bars: [55, 60, 58, 65, 70, 68, 75] },
      { crop: 'üåΩ Corn', price: '‚Çπ1,820', change: '-2.1%', up: false, signal: 'hold', bars: [80, 75, 72, 70, 68, 65, 67] },
      { crop: 'ü´ò Soybean', price: '‚Çπ4,280', change: '+11.3%', up: true, signal: 'buy', bars: [50, 55, 60, 65, 70, 75, 85] },
      { crop: 'üçÖ Tomato', price: '‚Çπ1,640', change: '+7.8%', up: true, signal: 'buy', bars: [40, 42, 50, 55, 60, 65, 72] },
      { crop: 'üå∏ Cotton', price: '‚Çπ5,900', change: '-0.5%', up: false, signal: 'hold', bars: [70, 72, 68, 70, 69, 68, 70] },
      { crop: 'üåæ Rice', price: '‚Çπ2,050', change: '+1.2%', up: true, signal: 'hold', bars: [60, 62, 61, 63, 65, 64, 66] },
    ];

    function renderPrices() {
      const grid = document.getElementById('price-grid');
      grid.innerHTML = priceData.map(p => `
    <div class="price-card">
      <div class="price-crop">${p.crop}</div>
      <div class="price-value">${p.price}</div>
      <div class="price-change ${p.up ? 'price-up' : 'price-down'}">
        ${p.up ? '‚ñ≤' : '‚ñº'} ${p.change} (7 days)
      </div>
      <div class="mini-chart">
        ${p.bars.map((h, i) => `<div class="bar ${i === p.bars.length - 1 ? 'active' : ''}" style="height:${h}%"></div>`).join('')}
      </div>
      <div>
        <span class="sell-signal ${p.signal === 'buy' ? 'signal-buy' : p.signal === 'sell' ? 'signal-sell' : 'signal-hold'}">
          ${p.signal === 'buy' ? '‚úÖ SELL NOW' : p.signal === 'sell' ? '‚ùå AVOID SELLING' : '‚è≥ HOLD & WAIT'}
        </span>
      </div>
    </div>
  `).join('');
    }
    renderPrices();

    function refreshPrices() {
      priceData.forEach(p => {
        p.bars = p.bars.map(b => Math.max(20, Math.min(95, b + (Math.random() - 0.5) * 10)));
      });
      renderPrices();
    }

    function updatePrices() { refreshPrices(); }

    const calcPrices = { wheat: 2150, corn: 1820, soybean: 4280, tomato: 1640 };
    function calcProfit() {
      const crop = document.getElementById('calc-crop').value;
      const qty = parseFloat(document.getElementById('calc-qty').value) || 0;
      const cost = parseFloat(document.getElementById('calc-cost').value) || 0;
      const price = calcPrices[crop];
      const revenue = qty * price;
      const totalCost = qty * cost;
      const profit = revenue - totalCost;
      document.getElementById('mkt-price').textContent = `‚Çπ${price.toLocaleString()}/q`;
      document.getElementById('total-rev').textContent = `‚Çπ${revenue.toLocaleString()}`;
      document.getElementById('total-cost').textContent = `‚Çπ${totalCost.toLocaleString()}`;
      document.getElementById('net-profit').textContent = `${profit >= 0 ? '‚Çπ' + profit.toLocaleString() : '-‚Çπ' + Math.abs(profit).toLocaleString()}`;
      document.getElementById('net-profit').style.color = profit >= 0 ? 'var(--lime)' : '#f87171';
    }

    // ===== SOIL HEALTH =====
    function updateSoilMeters() {
      const n = parseFloat(document.getElementById('soil-n').value) || 0;
      const p = parseFloat(document.getElementById('soil-p').value) || 0;
      const k = parseFloat(document.getElementById('soil-k').value) || 0;
      const oc = parseFloat(document.getElementById('soil-oc').value) || 0;
      const ph = parseFloat(document.getElementById('soil-ph').value) || 0;

      // N: low<200, med 200-280, high>280
      const nPct = Math.min(100, (n / 350) * 100);
      const nStatus = n < 200 ? { label: 'Low', color: '#f87171' } : n < 280 ? { label: 'Medium', color: 'var(--wheat)' } : { label: 'High', color: 'var(--lime)' };
      document.getElementById('n-fill').style.width = nPct + '%';
      document.getElementById('n-fill').style.background = n < 200 ? 'linear-gradient(90deg,#f87171,#fb923c)' : n < 280 ? 'linear-gradient(90deg,var(--wheat),var(--sun))' : 'linear-gradient(90deg,var(--lime),#5fa825)';
      document.getElementById('n-val').textContent = nStatus.label;
      document.getElementById('n-val').style.color = nStatus.color;

      const pPct = Math.min(100, (p / 40) * 100);
      const pStatus = p < 15 ? { label: 'Low', color: '#f87171' } : p < 25 ? { label: 'Medium', color: 'var(--wheat)' } : { label: 'High', color: 'var(--lime)' };
      document.getElementById('p-fill').style.width = pPct + '%';
      document.getElementById('p-val').textContent = pStatus.label;
      document.getElementById('p-val').style.color = pStatus.color;

      const kPct = Math.min(100, (k / 400) * 100);
      const kStatus = k < 150 ? { label: 'Low', color: '#f87171' } : k < 250 ? { label: 'Medium', color: 'var(--wheat)' } : { label: 'High', color: 'var(--lime)' };
      document.getElementById('k-fill').style.width = kPct + '%';
      document.getElementById('k-val').textContent = kStatus.label;
      document.getElementById('k-val').style.color = kStatus.color;

      const ocPct = Math.min(100, (oc / 2) * 100);
      const ocStatus = oc < 0.5 ? { label: 'Very Low', color: '#f87171' } : oc < 0.75 ? { label: 'Low', color: '#f87171' } : oc < 1.0 ? { label: 'Medium', color: 'var(--wheat)' } : { label: 'Good', color: 'var(--lime)' };
      document.getElementById('oc-fill').style.width = ocPct + '%';
      document.getElementById('oc-val').textContent = ocStatus.label;
      document.getElementById('oc-val').style.color = ocStatus.color;

      const phPct = Math.abs(7 - ph) < 0.5 ? 85 : Math.abs(7 - ph) < 1 ? 65 : 40;
      const phStatus = Math.abs(7 - ph) < 0.5 ? { label: 'Optimal', color: 'var(--lime)' } : Math.abs(7 - ph) < 1 ? { label: 'Acceptable', color: 'var(--wheat)' } : { label: 'Adjust', color: '#f87171' };
      document.getElementById('ph-fill').style.width = phPct + '%';
      document.getElementById('ph-val').textContent = phStatus.label;
      document.getElementById('ph-val').style.color = phStatus.color;

      updateFertPlan();
    }

    function updateFertPlan() {
      const crop = document.getElementById('soil-crop').value;
      const n = parseFloat(document.getElementById('soil-n').value) || 180;
      const p = parseFloat(document.getElementById('soil-p').value) || 22;
      const k = parseFloat(document.getElementById('soil-k').value) || 260;

      const urea = n < 200 ? '110 kg/acre' : n < 280 ? '55 kg/acre' : '0 kg/acre ‚úì';
      const dap = p < 15 ? '55 kg/acre' : p < 25 ? '35 kg/acre' : '0 kg/acre ‚úì';
      const mop = k < 150 ? '40 kg/acre' : k < 250 ? '20 kg/acre' : '0 kg/acre ‚úì';

      document.getElementById('fert-plan').innerHTML = `
    <div class="fert-title">üåø AI Fertilizer Recommendation ‚Äî ${crop}</div>
    <div class="fert-item"><span>Urea (N Source)</span><span class="fert-amount">${urea}</span></div>
    <div class="fert-item"><span>DAP (P Source)</span><span class="fert-amount">${dap}</span></div>
    <div class="fert-item"><span>MOP (K Source)</span><span class="fert-amount">${mop}</span></div>
    <div class="fert-item"><span>FYM / Compost</span><span class="fert-amount">2 tons/acre</span></div>
    <div class="fert-item"><span>Micronutrient Mix</span><span class="fert-amount">5 kg/acre</span></div>
    <div style="font-size:0.78rem;color:rgba(255,255,255,0.35);margin-top:10px;line-height:1.5;">
      ‚è± Split nitrogen application: 50% at sowing, 50% at ${crop === 'Corn' ? 'knee-high' : crop === 'Wheat' ? 'tillering' : crop === 'Tomato' ? 'flowering' : 'vegetative'} stage for best uptake.
    </div>
  `;
    }

    // ===== SMART FARM LOGIC =====
    function toggleMotor(name, checkbox) {
      const status = checkbox.checked ? "ON" : "OFF";
      const statusBox = document.getElementById('motor-status');

      const msg = checkbox.checked ?
        `<div><strong>${name}</strong> turned <strong>ON</strong></div><div style="font-size:0.75rem;margin-top:2px;">üì± Notification sent to Owner's Phone</div>` :
        `<div><strong>${name}</strong> turned <strong>OFF</strong></div><div style="font-size:0.75rem;margin-top:2px;">üì± Device disconnected via VIGI Cloud</div>`;

      statusBox.style.display = 'flex';
      statusBox.innerHTML = `<div class="alert-icon">${checkbox.checked ? 'üåä' : 'üõë'}</div><div>${msg}</div>`;

      // Auto hide after 4s
      setTimeout(() => { statusBox.style.display = 'none'; }, 4000);
    }

    let cctvStream = null;
    let motionInterval = null;
    const cctvVideo = document.getElementById('cctv-feed');
    let lastFrameData = null;

    async function startCCTV() {
      // Security Check
      if (!ownerDetails) {
        checkSecurityLogin();
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        cctvStream = stream;
        cctvVideo.srcObject = stream;

        document.getElementById('security-log').innerHTML = `<div class="log-item" style="color:#7ecb35;">‚úÖ System Active - Monitoring...</div>` + document.getElementById('security-log').innerHTML;

        // Start Motion Detection Loop
        startMotionDetection();

      } catch (err) {
        alert("Camera access denied: " + err);
      }
    }

    function stopCCTV() {
      if (cctvStream) {
        cctvStream.getTracks().forEach(track => track.stop());
        cctvStream = null;
      }
      if (motionInterval) clearInterval(motionInterval);
      document.getElementById('security-log').innerHTML += `<div class="log-item">‚èπ Feed Stopped</div>`;
    }

    function startMotionDetection() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const width = 100; // Low res for performance
      const height = 100;
      canvas.width = width;
      canvas.height = height;

      motionInterval = setInterval(() => {
        if (!cctvStream) return;

        ctx.drawImage(cctvVideo, 0, 0, width, height);
        const frameData = ctx.getImageData(0, 0, width, height).data;

        if (lastFrameData) {
          let diff = 0;
          // Simple pixel diff
          for (let i = 0; i < frameData.length; i += 4) {
            diff += Math.abs(frameData[i] - lastFrameData[i]); // R
            diff += Math.abs(frameData[i + 1] - lastFrameData[i + 1]); // G
            diff += Math.abs(frameData[i + 2] - lastFrameData[i + 2]); // B
          }

          // Sensitivity threshold
          if (diff > 400000) {
            triggerSecurityAlert();
          }
        }

        lastFrameData = frameData;
      }, 500); // Check every 500ms
    }

    function triggerSecurityAlert() {
      // play sound
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.type = 'sawtooth';
      oscillator.frequency.value = 800; // Hz
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.start();

      // Siren effect
      gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
      oscillator.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
      oscillator.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.2);
      oscillator.stop(audioCtx.currentTime + 0.5);

      // CAPTURE IMAGE OF INTRUDER
      const video = document.getElementById('cctv-feed');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const intruderImg = canvas.toDataURL('image/jpeg');

      // SHOW ALERT MODAL
      const now = new Date().toLocaleTimeString();

      // Update Log
      const log = document.getElementById('security-log');
      log.innerHTML = `<div class="log-item alert">
        üö® MOTION DETECTED at ${now}<br/>
        <img src="${intruderImg}" style="width:100px;border-radius:4px;margin-top:4px;border:1px solid #fa5252;">
      </div>` + log.innerHTML;

      // Simulate Sending Message
      // Simulate Sending Message
      const disPhone = ownerDetails?.phone || '+91...';
      showNotification("üö® Security Alert", `Motion detected! Image sent to ${disPhone}.`);

      // Speak Warning
      speakText("Security Alert! Motion detected.");

      // WhatsApp Integration (Real - Auto)
      const ownerName = ownerDetails?.name || 'Owner';
      const ownerPhone = ownerDetails?.phone || '';

      const msg = `üö® *Security Alert!* \nHello ${ownerName}, Motion detected at farm at ${now}. \nI have pasted the intruder image below. üëá`;
      const waLink = `https://wa.me/${ownerPhone}?text=${encodeURIComponent(msg)}`;

      // Custom Modal for "Message Sent" (WhatsApp Style)
      const modal = document.createElement('div');
      modal.id = 'intruder-modal';
      modal.style.cssText = `
        position: fixed; top: 20px; right: 20px; width: 320px;
        background: #121b22; color: #fff; border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 10000;
        font-family: 'Segoe UI', sans-serif; overflow: hidden;
        animation: slideInRight 0.4s ease-out;
      `;

      modal.innerHTML = `
        <div style="background:#00a884;padding:12px 16px;display:flex;align-items:center;gap:10px;">
          <div style="font-size:1.2rem;">üì±</div>
          <div>
            <div style="font-weight:700;font-size:0.95rem;">WhatsApp Alert</div>
            <div style="font-size:0.75rem;opacity:0.8;">Action Required</div>
          </div>
          <button onclick="document.getElementById('intruder-modal').remove()" style="margin-left:auto;background:none;border:none;color:#fff;font-size:1.2rem;">&times;</button>
        </div>
        <div style="padding:16px;">
          <div style="font-size:0.9rem;margin-bottom:10px;">üö® <strong>Intruder Detected!</strong><br>Alerting: <strong>${ownerName}</strong> (${ownerPhone})<br><br>1. Click "Send via WhatsApp"<br>2. <strong>Paste (Ctrl+V)</strong> to attach image</div>
          <img src="${intruderImg}" style="width:100%;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
          <div style="margin-top:12px;">
            <a href="${waLink}" target="_blank" style="text-decoration:none;display:block;width:100%;text-align:center;background:#25D366;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;">
               üì≤ Send to ${phone || 'WhatsApp'}
            </a>
             <button onclick="document.getElementById('intruder-modal').remove()" style="width:100%;margin-top:8px;background:none;color:#aaa;border:none;padding:8px;font-size:0.8rem;">Dismiss</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Auto remove after 15s
      setTimeout(() => { if (document.getElementById('intruder-modal')) document.getElementById('intruder-modal').remove(); }, 15000);

      // Throttle alerts (pause detection briefly)
      clearInterval(motionInterval);
      setTimeout(startMotionDetection, 5000);
    }

    // ===== VOICE ASSISTANT =====
    const languages = {
      'en-IN': { name: 'English (India)', code: 'en-IN' },
      'hi-IN': { name: 'Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)', code: 'hi-IN' },
      'ta-IN': { name: 'Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)', code: 'ta-IN' },
      'te-IN': { name: 'Telugu (telugu)', code: 'te-IN' }
    };

    function speakText(text) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();

        const langCode = document.getElementById('voice-lang')?.value || 'en-IN';
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = langCode;

        // Try to find a matching voice
        const voices = window.speechSynthesis.getVoices();
        const specificVoice = voices.find(v => v.lang === langCode);
        if (specificVoice) utterance.voice = specificVoice;

        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
      }
    }

    function startVoiceInput() {
      // Check browser support
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Voice input not supported in this browser. Please use Google Chrome or Edge.");
        return;
      }

      const recognition = new SpeechRecognition();
      const langCode = document.getElementById('voice-lang')?.value || 'en-IN';
      recognition.lang = langCode;
      recognition.continuous = false;
      recognition.interimResults = false;

      const btn = document.getElementById('mic-btn');

      recognition.onstart = function () {
        btn.innerHTML = 'üî¥ Listening...';
        btn.classList.add('pulse-anim'); // Add CSS class for pulsing effect if needed
      };

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('chat-input').value = transcript;
        setTimeout(() => sendChat(), 500); // Auto-send after brief pause
      };

      recognition.onerror = function (event) {
        console.error("Voice error:", event.error);
        if (event.error === 'no-speech') {
          showNotification("Voice Error", "No speech detected. Please try again.");
        } else if (event.error === 'not-allowed') {
          alert("Microphone access denied. Please allow microphone permissions.");
        } else {
          showNotification("Voice Error", "Error: " + event.error);
        }
        btn.innerHTML = 'üé§';
      };

      recognition.onend = function () {
        btn.innerHTML = 'üé§';
        btn.classList.remove('pulse-anim');
      };

      try {
        recognition.start();
      } catch (e) {
        console.error("Recognition start error:", e);
      }
    }



    // NEW NOTIFICATION SYSTEM
    function showNotification(title, message) {
      const notif = document.createElement('div');
      notif.style.cssText = `
            position: fixed; top: 20px; right: 20px; background: #1a1b1e; border-left: 4px solid #fa5252;
            padding: 15px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 10000;
            font-family: 'Inter', sans-serif; animation: slideIn 0.3s ease-out;
        `;
      notif.innerHTML = `<strong>${title}</strong><div style="font-size:0.9rem;margin-top:4px;">${message}</div>`;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.style.opacity = '0';
        setTimeout(() => notif.remove(), 300);
      }, 5000);
    }

    function ptz(dir) {
      // Sim movement
      const video = document.getElementById('cctv-feed');
      const overlay = document.querySelector('.cctv-overlay');
      const originalText = overlay.innerHTML;

      overlay.innerHTML = `<div class="rec-dot"></div> MOVING ${dir.toUpperCase()}...`;

      // visual nudging
      let x = 0, y = 0;
      if (dir === 'left') x = 30;
      if (dir === 'right') x = -30;
      if (dir === 'up') y = 30;
      if (dir === 'down') y = -30;

      video.style.transition = 'transform 0.5s';
      video.style.transform = `scaleX(-1) translate(${x}px, ${y}px)`;

      setTimeout(() => {
        video.style.transform = `scaleX(-1) translate(0, 0)`;
        overlay.innerHTML = originalText;
      }, 800);
    }

    function toggleFullscreen() {
      const elem = document.getElementById('cctv-container');
      if (!document.fullscreenElement) {
        elem.requestFullscreen().catch(err => {
          alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // ===== IOT DEVICE MANAGER =====
    function openDeviceManager() {
      document.getElementById('device-manager').style.display = 'flex';
      // Sim scanning
      document.getElementById('scan-anim').style.display = 'block';
      document.getElementById('device-list').style.display = 'none';

      setTimeout(() => {
        document.getElementById('scan-anim').style.display = 'none';
        document.getElementById('device-list').style.display = 'flex';
      }, 2000);
    }

    function closeDeviceManager() {
      document.getElementById('device-manager').style.display = 'none';
    }

    function connectDevice(name) {
      if (name.includes('Phone') || name.includes('Generic')) {
        // Show manual input for cameras
        document.getElementById('device-list').style.display = 'none';
        document.getElementById('manual-ip-input').style.display = 'block';
        return;
      }

      closeDeviceManager();
      document.getElementById('sensor-placeholder').style.display = 'none';
      document.getElementById('live-sensors').style.display = 'grid';

      alert(`‚úÖ Connected to ${name}`);

      // Start Simulating Data Stream
      startSensorStream();
    }

    function connectManualDevice() {
      const url = document.getElementById('camera-url').value;
      if (!url) { alert("Please enter a valid URL"); return; }

      // Try to set CCTV feed to this URL
      const video = document.getElementById('cctv-feed');
      video.srcObject = null; // Clear stream
      video.src = url; // Set generic URL (mjpeg/mp4)
      video.play().catch(e => console.log("Stream play error (might need CORS/Auth):", e));

      closeDeviceManager();
      alert(`‚úÖ Connected to Camera at ${url}`);

      document.getElementById('security-log').innerHTML = `<div class="log-item" style="color:#7ecb35;">‚úÖ LIVE: ${url}</div>` + document.getElementById('security-log').innerHTML;
    }

    let sensorInterval = null;
    function startSensorStream() {
      if (sensorInterval) clearInterval(sensorInterval);

      sensorInterval = setInterval(() => {
        // Sim random fluctuations
        const moist = 55 + Math.floor(Math.random() * 5);
        const temp = 28 + Math.random().toFixed(1);

        // Sim NPK data
        const n = 180 + Math.floor(Math.random() * 10);
        const p = 22 + Math.floor(Math.random() * 3);
        const k = 260 + Math.floor(Math.random() * 10);

        // Update Widgets
        document.getElementById('live-moisture').textContent = `${moist}%`;
        document.getElementById('live-temp').textContent = `${temp}¬∞C`;
        document.getElementById('live-npk').textContent = `N:${n} P:${p} K:${k}`;

        // Auto-update Soil Inputs (Integration)
        if (document.getElementById('soil-n')) {
          document.getElementById('soil-n').value = n;
          document.getElementById('soil-p').value = p;
          document.getElementById('soil-k').value = k;
          updateSoilMeters(); // Trigger re-calc
        }

      }, 2000);
    }

    // ===== AI CHATBOT =====
    const aiResponses = {
      'en-IN': {
        'yellow': `üåΩ **Yellow Corn Leaves ‚Äî Diagnosis**\n\nYellow leaves in corn typically indicate:\n\n1. **Nitrogen deficiency** (most common) ‚Äî yellowing starts from leaf tip and progresses inward.\n2. **Sulfur deficiency** ‚Äî yellowing on young leaves first.\n\nüí° **Quick Test:** If oldest leaves are yellow ‚Üí Nitrogen. Apply Urea @ 30kg/acre.`,
        'sell': `üìà **Best Time to Sell Wheat**\n\n‚úÖ **Current Price:** ‚Çπ2,150/quintal (up 4.2%)\n\n**Recommendation:**\n- Sell 30‚Äì40% NOW.\n- Hold the rest for 10 days.\n- Target price: ‚Çπ2,350/quintal.`,
        'default': `üåæ **FarmPulse "AI Suggests"**\n\nI can help you in **English, Hindi, Telugu or Tamil**.\n\nAsk me about:\n- Crop diseases ü¶†\n- Market prices üí∞\n- Fertilizer tips üåø\n\nPlease select your language above ‚ÜóÔ∏è`
      },
      'hi-IN': {
        'yellow': `üåΩ **‡§Æ‡§ï‡•ç‡§ï‡§æ ‡§ï‡•Ä ‡§™‡•Ä‡§≤‡•Ä ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç ‚Äî ‡§®‡§ø‡§¶‡§æ‡§®**\n\n‡§Æ‡§ï‡•ç‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§™‡•Ä‡§≤‡•Ä ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à:\n\n1. **‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® ‡§ï‡•Ä ‡§ï‡§Æ‡•Ä** (‡§∏‡§¨‡§∏‡•á ‡§Ü‡§Æ) ‚Äî ‡§™‡•Ä‡§≤‡§æ‡§™‡§® ‡§™‡§§‡•ç‡§§‡•Ä ‡§ï‡•Ä ‡§®‡•ã‡§ï ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§\n2. **‡§∏‡§≤‡•ç‡§´‡§∞ ‡§ï‡•Ä ‡§ï‡§Æ‡•Ä** ‚Äî ‡§®‡§à ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§™‡§∞ ‡§™‡•Ä‡§≤‡§æ‡§™‡§®‡•§\n\nüí° **‡§∏‡•Å‡§ù‡§æ‡§µ:** ‡§Ø‡§¶‡§ø ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§™‡•Ä‡§≤‡•Ä ‡§π‡•à‡§Ç ‚Üí ‡§Ø‡•Ç‡§∞‡§ø‡§Ø‡§æ @ 30 ‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ/‡§è‡§ï‡§°‡§º ‡§°‡§æ‡§≤‡•á‡§Ç‡•§`,
        'sell': `üìà **‡§ó‡•á‡§π‡•Ç‡§Ç ‡§¨‡•á‡§ö‡§®‡•á ‡§ï‡§æ ‡§∏‡§π‡•Ä ‡§∏‡§Æ‡§Ø**\n\n‚úÖ **‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§≠‡§æ‡§µ:** ‚Çπ2,150/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤ (4.2% ‡§ä‡§™‡§∞)\n\n**‡§∏‡§≤‡§æ‡§π:**\n- 30-40% ‡§Ö‡§≠‡•Ä ‡§¨‡•á‡§ö‡•á‡§Ç‡•§\n- ‡§¨‡§æ‡§ï‡•Ä 10 ‡§¶‡§ø‡§® ‡§∞‡•ã‡§ï‡§ï‡§∞ ‡§∞‡§ñ‡•á‡§Ç‡•§\n- ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§≠‡§æ‡§µ: ‚Çπ2,350/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤‡•§`,
        'default': `üåæ **FarmPulse "AI ‡§∏‡•Å‡§ù‡§æ‡§µ"**\n\n‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ñ‡•á‡§§‡•Ä ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§\n\n‡§Æ‡•Å‡§ù‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç:\n- ‡§´‡§∏‡§≤ ‡§ï‡•á ‡§∞‡•ã‡§ó ü¶†\n- ‡§Æ‡§Ç‡§°‡•Ä ‡§≠‡§æ‡§µ üí∞\n- ‡§ñ‡§æ‡§¶ ‡§î‡§∞ ‡§â‡§∞‡•ç‡§µ‡§∞‡§ï üåø\n\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§ä‡§™‡§∞ ‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç ‚ÜóÔ∏è`
      },
      'te-IN': {
        'yellow': `üåΩ **‡∞Æ‡±ä‡∞ï‡±ç‡∞ï‡∞ú‡±ä‡∞®‡±ç‡∞® ‡∞Ü‡∞ï‡±Å‡∞≤‡±Å ‡∞™‡∞∏‡±Å‡∞™‡±Å ‡∞∞‡∞Ç‡∞ó‡±Å ‚Äî ‡∞®‡∞ø‡∞µ‡∞æ‡∞∞‡∞£**\n\n‡∞Ü‡∞ï‡±Å‡∞≤‡±Å ‡∞™‡∞∏‡±Å‡∞™‡±Å ‡∞∞‡∞Ç‡∞ó‡±Å‡∞≤‡±ã‡∞ï‡∞ø ‡∞Æ‡∞æ‡∞∞‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞ï‡∞æ‡∞∞‡∞£‡∞æ‡∞≤‡±Å:\n\n1. **‡∞®‡∞§‡±ç‡∞∞‡∞ú‡∞®‡∞ø ‡∞≤‡±ã‡∞™‡∞Ç** ‚Äî ‡∞Ü‡∞ï‡±Å ‡∞ö‡∞ø‡∞µ‡∞∞ ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞™‡∞∏‡±Å‡∞™‡±Å ‡∞∞‡∞Ç‡∞ó‡±Å ‡∞Æ‡±ä‡∞¶‡∞≤‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø.\n2. **‡∞∏‡∞≤‡±ç‡∞´‡∞∞‡±ç ‡∞≤‡±ã‡∞™‡∞Ç** ‚Äî ‡∞≤‡±á‡∞§ ‡∞Ü‡∞ï‡±Å‡∞≤‡±Å ‡∞™‡∞∏‡±Å‡∞™‡±Å ‡∞∞‡∞Ç‡∞ó‡±Å‡∞≤‡±ã ‡∞â‡∞Ç‡∞ü‡∞æ‡∞Ø‡∞ø.\n\nüí° **‡∞∏‡∞≤‡∞π‡∞æ:** ‡∞Æ‡±Å‡∞¶‡±Å‡∞∞‡±Å ‡∞Ü‡∞ï‡±Å‡∞≤‡±Å ‡∞™‡∞∏‡±Å‡∞™‡±Å ‡∞∞‡∞Ç‡∞ó‡±Å‡∞≤‡±ã ‡∞â‡∞Ç‡∞ü‡±á ‚Üí ‡∞é‡∞ï‡∞∞‡∞æ‡∞ï‡±Å 30 ‡∞ï‡±á‡∞ú‡±Ä‡∞≤ ‡∞Ø‡±Ç‡∞∞‡∞ø‡∞Ø‡∞æ ‡∞µ‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.`,
        'sell': `üìà **‡∞ó‡±ã‡∞ß‡±Å‡∞Æ‡∞≤‡±Å ‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞∏‡∞∞‡±à‡∞® ‡∞∏‡∞Æ‡∞Ø‡∞Ç**\n\n‚úÖ **‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞ß‡∞∞:** ‚Çπ2,150/ ‡∞ï‡±ç‡∞µ‡∞ø‡∞Ç‡∞ü‡∞æ‡∞≤‡±ç\n\n**‡∞∏‡∞≤‡∞π‡∞æ:**\n- 30-40% ‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞Ç‡∞°‡∞ø.\n- ‡∞Æ‡∞ø‡∞ó‡∞ø‡∞≤‡∞ø‡∞®‡∞µ‡∞ø 10 ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å ‡∞Ü‡∞ó‡∞Ç‡∞°‡∞ø.\n- ‡∞≤‡∞ï‡±ç‡∞∑‡±ç‡∞Ø ‡∞ß‡∞∞: ‚Çπ2,350.`,
        'default': `üåæ **FarmPulse "AI ‡∞∏‡∞≤‡∞π‡∞æ"**\n\n‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç! ‡∞Æ‡±Ä ‡∞™‡∞Ç‡∞ü‡∞ï‡±Å ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞∏‡∞Ç‡∞¶‡±á‡∞π‡∞æ‡∞≤‡∞®‡±Å ‡∞®‡∞®‡±ç‡∞®‡±Å ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø.\n\n- ‡∞™‡∞Ç‡∞ü ‡∞§‡±Ü‡∞ó‡±Å‡∞≥‡±ç‡∞≤‡±Å ü¶†\n- ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç ‡∞ß‡∞∞‡∞≤‡±Å üí∞\n- ‡∞é‡∞∞‡±Å‡∞µ‡±Å‡∞≤ ‡∞∏‡∞≤‡∞π‡∞æ‡∞≤‡±Å üåø\n\n‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡±à‡∞® ‡∞Æ‡±Ä ‡∞≠‡∞æ‡∞∑‡∞®‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø ‚ÜóÔ∏è`
      },
      'ta-IN': { // Copy of English/Simple placeholder for now as requested user focused on Telugu/Hindi
        'default': `üåæ **FarmPulse AI (Tamil)**\n\nVanakkam! Ask about crops, prices, and diseases.`
      }
    };

    function getAIResponse(msg) {
      const lang = document.getElementById('voice-lang')?.value || 'en-IN';
      const m = msg.toLowerCase();

      // Select dictionary based on lang
      const dict = aiResponses[lang] || aiResponses['en-IN'];

      // Simple keyword matching for demo
      if (m.includes('yellow') || m.includes('corn') || m.includes('leaf') || m.includes('‡§™‡§§‡•ç‡§§‡•Ä') || m.includes('‡∞Ü‡∞ï‡±Å')) return dict['yellow'] || dict['default'];
      if (m.includes('sell') || m.includes('price') || m.includes('market') || m.includes('‡§≠‡§æ‡§µ') || m.includes('‡∞ß‡∞∞')) return dict['sell'] || dict['default'];

      return dict['default'];
    }

    function formatMsg(text) {
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br/>');
    }

    function addMsg(text, role) {
      const container = document.getElementById('chat-container');
      const div = document.createElement('div');
      div.className = `chat-msg ${role}`;
      const avatar = role === 'ai' ? 'ü§ñ' : 'üë®‚Äçüåæ';
      div.innerHTML = `
    <div class="msg-avatar ${role}">${avatar}</div>
    <div class="msg-bubble">${role === 'ai' ? formatMsg(text) : text}</div>
  `;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function addTypingIndicator() {
      const container = document.getElementById('chat-container');
      const div = document.createElement('div');
      div.className = 'chat-msg ai'; div.id = 'typing-indicator';
      div.innerHTML = `<div class="msg-avatar ai">ü§ñ</div><div class="msg-bubble" style="display:flex;gap:6px;align-items:center;padding:16px;">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--lime);animation:pulse 1s infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:var(--lime);animation:pulse 1s 0.2s infinite;"></div>
    <div style="width:8px;height:8px;border-radius:50%;background:var(--lime);animation:pulse 1s 0.4s infinite;"></div>
  </div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;
      addMsg(msg, 'user');
      input.value = '';
      addTypingIndicator();
      setTimeout(() => {
        document.getElementById('typing-indicator')?.remove();
        addMsg(getAIResponse(msg), 'ai');
      }, 1400);
    }

    function sendQuick(msg) {
      showSection('doctor');
      setTimeout(() => {
        document.getElementById('chat-input').value = msg;
        sendChat();
      }, 300);
    }

    // Init
    // Force reset inputs to 0 to prevent browser caching old values
    document.querySelectorAll('.input-field[type="number"]').forEach(input => input.value = 0);

    calcProfit();
    calcProfit();
    updateSoilMeters();

    // ===== SECURITY LOGIN SYSTEM =====
    let ownerDetails = null; // { name: "Ravi", phone: "919876543210" }

    function checkSecurityLogin() {
      if (ownerDetails) return true;
      document.getElementById('security-login').style.display = 'flex';
      return false;
    }

    function saveSecurityDetails() {
      const name = document.getElementById('sec-name').value;
      const phone = document.getElementById('sec-phone').value;

      if (!name || !phone) { alert("Please enter both Name and Phone Number."); return; }

      ownerDetails = { name, phone };
      document.getElementById('security-login').style.display = 'none';
      alert(`‚úÖ Security System Armed for ${name}`);

      // Auto-start CCTV if this was triggered by startCCTV
      startCCTV();
    }
  </script>

  <!-- SECURITY LOGIN MODEL -->
  <div id="security-login"
    style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;align-items:center;justify-content:center;">
    <div class="card"
      style="width:90%;max-width:400px;text-align:center;border:1px solid var(--lime);box-shadow:0 0 30px rgba(126, 203, 53, 0.2);">
      <div style="font-size:3rem;margin-bottom:10px;">üõ°Ô∏è</div>
      <div class="card-title">Security Setup</div>
      <div class="card-sub">Enter owner details to arm the system.</div>
      <div class="divider"></div>

      <div style="text-align:left;margin-bottom:15px;">
        <label style="font-size:0.75rem;color:rgba(255,255,255,0.6);">Owner Name</label>
        <input type="text" id="sec-name" placeholder="e.g. Ravi Kumar" class="input-field" style="margin-top:5px;">
      </div>

      <div style="text-align:left;margin-bottom:20px;">
        <label style="font-size:0.75rem;color:rgba(255,255,255,0.6);">WhatsApp Number (with Country Code)</label>
        <input type="number" id="sec-phone" placeholder="e.g. 919876543210" class="input-field" style="margin-top:5px;">
      </div>

      <button class="btn btn-primary" onclick="saveSecurityDetails()"
        style="width:100%;justify-content:center;padding:12px;">‚úÖ Save & Arm System</button>
    </div>
  </div>
</body>

</html>